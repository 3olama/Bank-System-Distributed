package client;

import java.awt.Color;
import java.awt.Font;
import java.util.List;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JOptionPane;
import rmi.BankService;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;

public class MiniStatementResult extends JFrame {

    public MiniStatementResult(String cardNumber) {
        setTitle("Mini Statement");
        setLayout(null);

        JLabel bank = new JLabel("E-Bank");
        bank.setFont(new Font("Calibri", Font.BOLD, 20));
        bank.setBounds(160, 30, 100, 25);
        add(bank);

        JLabel nameLabel = new JLabel();
        nameLabel.setFont(new Font("Calibri", Font.BOLD, 15));
        nameLabel.setBounds(20, 90, 300, 20);
        add(nameLabel);

        JLabel cardLabel = new JLabel();
        cardLabel.setFont(new Font("Calibri", Font.BOLD, 15));
        cardLabel.setBounds(20, 110, 300, 20);
        add(cardLabel);

        JLabel mini = new JLabel();
        mini.setBounds(20, 140, 400, 300);
        add(mini);
        mini.setText("<html> <table><tr><th>Type</th><th>Date</th><th>&nbsp;&nbsp;Amount</th></tr>");

        JLabel balanceLabel = new JLabel();
        balanceLabel.setFont(new Font("Calibri", Font.BOLD, 15));
        balanceLabel.setBounds(20, 450, 400, 20);
        add(balanceLabel);

        try {
            // Connexion RMI
            Registry registry = LocateRegistry.getRegistry("localhost", 1099);
            BankService service = (BankService) registry.lookup("bankService");

            // Récupérer les infos du client
            String name = service.getCustomerName(cardNumber);
            nameLabel.setText("Name: " + name);

            // Masquer une partie du cardNumber
            cardLabel.setText("Card Number: " + cardNumber.substring(0,4) + "-XXXX-XXXX-" + cardNumber.substring(12));

            // Récupérer les transactions
            List<String> transactions = service.getMiniStatement(cardNumber);
            for (String tr : transactions) {
                // Chaque transaction doit être formatée comme "type,date,amount"
                String[] parts = tr.split(",");
                mini.setText(mini.getText() + "<tr><td>&nbsp;" + parts[0] + "&nbsp;</td><td>&nbsp;" + parts[1] + "&nbsp;</td><td>&nbsp;&nbsp;&nbsp;&nbsp;" + parts[2] + "</td></tr>");
            }

            // Récupérer le solde
            double balance = service.getAccountBalance(cardNumber);
            balanceLabel.setText("Your account balance is: " + balance + "$");

        } catch (Exception e) {
            e.printStackTrace();
            JOptionPane.showMessageDialog(this, "Error fetching mini statement: " + e.getMessage());
        } finally {
            mini.setText(mini.getText() + "</table></html>");
        }

        setSize(400, 600);
        setLocation(800, 150);
        getContentPane().setBackground(Color.WHITE);
        setVisible(true);
    }

    public static void main(String[] args) {
        new MiniStatementResult("1234567890123456");
    }
}
