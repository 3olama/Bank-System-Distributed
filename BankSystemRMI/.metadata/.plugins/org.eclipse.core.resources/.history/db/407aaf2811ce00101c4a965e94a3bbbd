package server;
import rmi.BankService;
import util.Conn;

import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.sql.*;

public class BankServiceImpl extends UnicastRemoteObject implements BankService {

    public BankServiceImpl() throws RemoteException {
        super();
    }

    @Override
    public String login(String cardNumber, String pin) throws RemoteException {
        String ssn = null;

        try (Connection conn = Conn.getConnection()) { //Appelle la méthode Conn.getConnection()
            // Préparation de la requête SQL avec paramètres pour sécuriser contre les injections SQL
            String sql = "SELECT a.ssn FROM card c JOIN accounts a ON c.account_number = a.account_number WHERE c.card_number = ? AND c.pin = ?";
            // créer l’objet qui enverra la requête à MySQL
            PreparedStatement ps = conn.prepareStatement(sql);
            // Remplacement du premier paramètre par le cardNumber fourni
            ps.setString(1, cardNumber);
            // Remplacement du second paramètre par le pin fourni
            ps.setString(2, pin);
            ResultSet rs = ps.executeQuery();
         // Si un enregistrement est trouvé on retourne le ssn correspondant
            if(rs.next()) { 
            	return rs.getString("ssn"); // Login réussi
            System.out.println("Login successful for card: " + cardNumber);
              } else {
            System.out.println("Login failed for card: " + cardNumber);
        }
            
            rs.close();
            ps.close();
        } catch (Exception e) {
            e.printStackTrace();
            throw new RemoteException("Database error in login()", e);
        }
        return ssn; // null si user n'a pas trouvé
    }
    
    @Override
    public boolean signupStepOne(String formno, String name, String ssn, String dob,String gender, String email, String marital,String address, String city, String state, String zip)
            throws RemoteException {

       try(Connection conn = Conn.getConnection()) {
            String query = "INSERT INTO Customer(formno, name, ssn, dob, gender, email, mariatal, address, city, state, zip) " +
                           "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            PreparedStatement ps = conn.prepareStatement(query);
            ps.setString(1, formno);
            ps.setString(2, name);
            ps.setString(3, ssn);
            ps.setString(4, dob);
            ps.setString(5, gender);
            ps.setString(6, email);
            ps.setString(7, marital);
            ps.setString(8, address);
            ps.setString(9, city);
            ps.setString(10, state);
            ps.setString(11, zip);

            int rows = ps.executeUpdate(); //exécute la requête d’insertion.
            return rows > 0;

        } catch (Exception e) {
            System.out.println("Signup Step 1 Error: " + e);
            return false;
        }
    }

    @Override
    public boolean signupStepTwo(String ssn, String fname, String passportNo, String race,
        String category, String income, String education,
        String occupation, String seniorCitizen, String existAcnt
    ) throws RemoteException  {

    try(Connection conn = Conn.getConnection()) {

        String query = "UPDATE Customer SET fname=?, passportNo=?, race=?, category=?, income=?, education=?, occupation=?, seniorCitizen=?, existAcnt=? WHERE ssn=?";
        
        PreparedStatement ps = conn.prepareStatement(query);
        ps.setString(1, fname);
        ps.setString(2, passportNo);
        ps.setString(3, race);
        ps.setString(4, category);
        ps.setString(5, income);
        ps.setString(6, education);
        ps.setString(7, occupation);
        ps.setString(8, seniorCitizen);
        ps.setString(9, existAcnt);
        ps.setString(10, ssn);

        int rows = ps.executeUpdate();
        ps.close();
        conn.close(); 

        // Si au moins 1 ligne modifiée → succès
        return rows > 0;
        
        
    } catch(Exception e) {
        e.printStackTrace();
        return false;
    }
    }

    @Override
    public boolean signupThree(
        String ssn,
        String accountType,
        String cardNumber,
        String pin,
        String atmCard,
        String chequeBook,
        String internetBanking,
        String mobileBanking,
        String eStatement,
        String emailSMS
    ) throws RemoteException {
        try (Connection conn = util.Conn.getConnection()) {

            String query1 = "UPDATE Customer SET acountType=?, cardNumber=?, pin=?, atmCard=?, chequeBook=?, internetBanking=?, mobileBanking=?, eStatement=?, emailSMS=? WHERE ssn=?";
            PreparedStatement ps1 = conn.prepareStatement(query1);
            ps1.setString(1, accountType);
            ps1.setString(2, cardNumber);
            ps1.setString(3, pin);
            ps1.setString(4, atmCard);
            ps1.setString(5, chequeBook);
            ps1.setString(6, internetBanking);
            ps1.setString(7, mobileBanking);
            ps1.setString(8, eStatement);
            ps1.setString(9, emailSMS);
            ps1.setString(10, ssn);
            ps1.executeUpdate();
            ps1.close();

            String query2 = "INSERT INTO Login(ssn, cardNumber, pin) VALUES (?, ?, ?)";
            PreparedStatement ps2 = conn.prepareStatement(query2);
            ps2.setString(1, ssn);
            ps2.setString(2, cardNumber);
            ps2.setString(3, pin);
            ps2.executeUpdate();
            ps2.close();

            String query3 = "INSERT INTO Accounts(ssn, balance) VALUES (?, ?)";
            PreparedStatement ps3 = conn.prepareStatement(query3);
            ps3.setString(1, ssn);
            ps3.setInt(2, 0);
            ps3.executeUpdate();
            ps3.close();

            conn.close();
            return true;

        } catch(Exception e) {
            e.printStackTrace();
            return false;
        }
    }
    
    
    @Override
    public double getBalance(String ssn) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            String sql = "SELECT balance FROM Accounts WHERE ssn=?";
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setString(1, ssn);
            ResultSet rs = ps.executeQuery();
            if(rs.next()) return rs.getDouble("balance");
            return -1;
        } catch(Exception e) {
            e.printStackTrace();
            return -1;
        }
    }

    @Override
    public boolean deposit(String ssn, double amount) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            conn.setAutoCommit(false);
            String sqlSel = "SELECT balance FROM Accounts WHERE ssn=? FOR UPDATE";
            PreparedStatement ps = conn.prepareStatement(sqlSel);
            ps.setString(1, ssn);
            ResultSet rs = ps.executeQuery();
            if(!rs.next()) { conn.rollback(); return false; }
            
            double balance = rs.getDouble("balance") + amount;
            PreparedStatement psUpd = conn.prepareStatement("UPDATE Accounts SET balance=? WHERE ssn=?");
            psUpd.setDouble(1, balance);
            psUpd.setString(2, ssn);
            psUpd.executeUpdate();
            
            PreparedStatement psIns = conn.prepareStatement("INSERT INTO Transactions(ssn, amount, type) VALUES(?,?,?)");
            psIns.setString(1, ssn);
            psIns.setDouble(2, amount);
            psIns.setString(3, "Deposit");
            psIns.executeUpdate();
            conn.commit();
            return true;
        } catch(Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    @Override
    public int withdraw(String ssn, double amount, String pin) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            conn.setAutoCommit(false);

            // Vérifier PIN
            PreparedStatement psPin = conn.prepareStatement("SELECT * FROM login WHERE ssn=? AND pin=?");
            psPin.setString(1, ssn);
            psPin.setString(2, pin);
            if (!psPin.executeQuery().next()) {
                conn.rollback();
                return 1; // PIN incorrect
            }

            // Vérifier solde
            PreparedStatement psBal = conn.prepareStatement("SELECT balance FROM Accounts WHERE ssn=? FOR UPDATE");
            psBal.setString(1, ssn);
            ResultSet rs = psBal.executeQuery();
            if (!rs.next()) {
                conn.rollback();
                return 3; // erreur serveur
            }
            double balance = rs.getDouble("balance");
            if (balance < amount) {
                conn.rollback();
                return 2; // solde insuffisant
            }

            // Débiter le compte
            balance -= amount;
            PreparedStatement psUpd = conn.prepareStatement("UPDATE Accounts SET balance=? WHERE ssn=?");
            psUpd.setDouble(1, balance);
            psUpd.setString(2, ssn);
            psUpd.executeUpdate();

            // Ajouter transaction
            PreparedStatement psIns = conn.prepareStatement("INSERT INTO Transactions(ssn, amount, type) VALUES(?,?,?)");
            psIns.setString(1, ssn);
            psIns.setDouble(2, amount);
            psIns.setString(3, "Withdraw");
            psIns.executeUpdate();
            // commit valide toute opèration
            conn.commit();
            return 0; // succès

        } catch (Exception e) {
            e.printStackTrace();
            return 3; // erreur serveur
        }
    }

    
    @Override
    public boolean changePin(String ssn, String oldPin, String newPin) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            conn.setAutoCommit(false);


            // Vérifier si l'ancien PIN est correct
            String checkQuery = "SELECT pin FROM Login WHERE ssn = ?";
            PreparedStatement ps = conn.prepareStatement(checkQuery);
            ps.setString(1, ssn);
            ResultSet rs = ps.executeQuery();

            if (!rs.next()) return false;
            String realOldPin = rs.getString("pin");

            if (!realOldPin.equals(oldPin)) return false;

            // Mettre à jour le PIN
            String updateLogin = "UPDATE Login SET pin = ? WHERE ssn = ?";
            ps = conn.prepareStatement(updateLogin);
            ps.setString(1, newPin);
            ps.setString(2, ssn);
            ps.executeUpdate();

            String updateCust = "UPDATE Customer SET pin = ? WHERE ssn = ?";
            ps = conn.prepareStatement(updateCust);
            ps.setString(1, newPin);
            ps.setString(2, ssn);
            ps.executeUpdate();

            conn.commit();
            conn.close();

            return true;
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }


    
    
    
    
}
