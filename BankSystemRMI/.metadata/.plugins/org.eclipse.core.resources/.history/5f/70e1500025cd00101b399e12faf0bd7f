package server;
import rmi.BankService;
import util.Conn;

import java.rmi.RemoteException;
import java.rmi.server.UnicastRemoteObject;
import java.sql.*;

public class BankServiceImpl extends UnicastRemoteObject implements BankService {

    protected BankServiceImpl() throws RemoteException {
        super();
    }

    @Override
    public String login(String cardNumber, String pin) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            String sql = "SELECT * FROM customer WHERE cardNumber=? AND pin=?";
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setString(1, cardNumber);
            ps.setString(2, pin);
            ResultSet rs = ps.executeQuery();
            if(rs.next()) return rs.getString("ssn");
            else return null;
        } catch(Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    @Override
    public double getBalance(String ssn) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            String sql = "SELECT balance FROM Accounts WHERE ssn=?";
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setString(1, ssn);
            ResultSet rs = ps.executeQuery();
            if(rs.next()) return rs.getDouble("balance");
            return -1;
        } catch(Exception e) {
            e.printStackTrace();
            return -1;
        }
    }

    @Override
    public boolean deposit(String ssn, double amount) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            conn.setAutoCommit(false);
            String sqlSel = "SELECT balance FROM Accounts WHERE ssn=? FOR UPDATE";
            PreparedStatement ps = conn.prepareStatement(sqlSel);
            ps.setString(1, ssn);
            ResultSet rs = ps.executeQuery();
            if(!rs.next()) { conn.rollback(); return false; }
            double balance = rs.getDouble("balance") + amount;
            PreparedStatement psUpd = conn.prepareStatement("UPDATE Accounts SET balance=? WHERE ssn=?");
            psUpd.setDouble(1, balance);
            psUpd.setString(2, ssn);
            psUpd.executeUpdate();
            PreparedStatement psIns = conn.prepareStatement("INSERT INTO Transactions(ssn, amount, type) VALUES(?,?,?)");
            psIns.setString(1, ssn);
            psIns.setDouble(2, amount);
            psIns.setString(3, "Deposit");
            psIns.executeUpdate();
            conn.commit();
            return true;
        } catch(Exception e) {
            e.printStackTrace();
            return false;
        }
    }

    @Override
    public int withdraw(String ssn, double amount, String pin) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            conn.setAutoCommit(false);

            // VÃ©rifier PIN
            PreparedStatement psPin = conn.prepareStatement("SELECT * FROM login WHERE ssn=? AND pin=?");
            psPin.setString(1, ssn);
            psPin.setString(2, pin);
            if(!psPin.executeQuery().next()) { conn.rollback(); return 1; }

            PreparedStatement psBal = conn.prepareStatement("SELECT balance FROM Accounts WHERE ssn=? FOR UPDATE");
            psBal.setString(1, ssn);
            ResultSet rs = psBal.executeQuery();
            if(!rs.next()) { conn.rollback(); return 3; }

            double balance = rs.getDouble("balance");
            if(balance < amount) { conn.rollback(); return 2; }

            balance -= amount;
            PreparedStatement psUpd = conn.prepareStatement("UPDATE Accounts SET balance=? WHERE ssn=?");
            psUpd.setDouble(1, balance);
            psUpd.setString(2, ssn);
            psUpd.executeUpdate();

            PreparedStatement psIns = conn.prepareStatement("INSERT INTO Transactions(ssn, amount, type) VALUES(?,?,?)");
            psIns.setString(1, ssn);
            psIns.setDouble(2, amount);
            psIns.setString(3, "Withdraw");
            psIns.executeUpdate();

            conn.commit();
            return 0;
        } catch(Exception e) {
            e.printStackTrace();
            return 3;
        }
    }

    @Override
    public boolean changePin(String ssn, String oldPin, String newPin) throws RemoteException {
        try (Connection conn = Conn.getConnection()) {
            PreparedStatement ps = conn.prepareStatement("UPDATE Customer SET pin=? WHERE ssn=? AND pin=?");
            ps.setString(1, newPin);
            ps.setString(2, ssn);
            ps.setString(3, oldPin);
            return ps.executeUpdate() == 1;
            
        } catch(Exception e) {
            e.printStackTrace();
            return false;
        }
    }
    

    
    
    
    
}
